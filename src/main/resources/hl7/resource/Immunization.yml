#
# (C) Copyright IBM Corp. 2020
#
# SPDX-License-Identifier: Apache-2.0
#
resourceType: Immunization
id:
   type: STRING
   valueOf: UUID.randomUUID()
   expressionType: JEXL

identifier:
   valueOf: datatype/Identifier
   generateList: true
   expressionType: resource
   vars:
      system: SYSTEM_URL, $sys
      value: BUILD_IDENTIFIER_FROM_CWE, RXA.5
   constants:
      sys: "urn:id:extID"
status:
   valueOf: "GeneralUtils.getImmunizationStatus(rxa18,rxa20,orc5)"
   expressionType: JEXL
   vars:
      rxa18: RXA.18
      rxa20: RXA.20
      orc5: ORC.5
statusReason_1:
   condition: $rxa18 NOT_NULL
   valueOf: datatype/CodeableConcept
   expressionType: resource
   specs: RXA.18
   vars:
      rxa18: RXA.18
statusReason_2:
   valueOf: datatype/CodeableConcept_var
   expressionType: resource
   condition: $rxa18 NULL && $statCode EQUALS RE
   vars:
      rxa18: RXA.18
      statCode: STRING, RXA.20
   constants:
      code: "PATOBJ"
      display: "Patient Refusal"
      system: "http://terminology.hl7.org/CodeSystem/v3-ActReason"
statusReason_3:
   valueOf: datatype/CodeableConcept_var
   expressionType: resource
   condition: $rxa18 NULL && $rxa20 NULL && $obx31 EQUALS 30945-0
   vars:
      rxa18: RXA.18
      rxa20: RXA.20
      obx31: String, OBX.3.1
   constants:
      code: "MEDPREC"
      display: "medical precaution"
      system: "http://terminology.hl7.org/CodeSystem/v3-ActReason"
statusReason_4:
   valueOf: datatype/CodeableConcept_var
   expressionType: resource
   condition: $rxa18 NULL && $rxa20 NULL && $obx31 EQUALS 59784-9
   vars:
      rxa18: RXA.18
      rxa20: RXA.20
      obx31: String, OBX.3.1
   constants:
      code: "IMMUNE"
      display: "immunity"
      system: "http://terminology.hl7.org/CodeSystem/v3-ActReason"
vaccineCode_1:
   valueOf: datatype/CodeableConcept
   expressionType: resource
   specs: RXA.5
   vars:
      code: RXA.5
vaccineCode_2:
   condition: $obx31 EQUALS 30956-7 && $rxa5 NULL
   valueOf: datatype/CodeableConcept
   expressionType: resource
   specs: OBX.5
   vars:
      rxa5: RXA.5
      obx31: String, OBX.3.1
patient:
   valueOf: datatype/Reference
   required: true
   expressionType: resource
   specs: $Patient
encounter:
   valueOf: datatype/Reference
   expressionType: resource
   specs: $Encounter
occurrenceDateTime:
   required: true
   type: DATE_TIME
   valueOf: RXA.3
   expressionType: HL7Spec
primarySource:
   value: true
   condition: $rxa9 NOT_NULL
   vars:
      rxa9: RXA.9
reportOrigin:
   valueOf: datatype/CodeableConcept
   expressionType: resource
   specs: RXA.9
manufacturer:
   condition: $rxa17 NOT_NULL
   valueOf: resource/Organization
   expressionType: reference
   specs: RXA.17
   vars: 
      rxa17: RXA.17
lotNumber:
   type: STRING
   valueOf: RXA.15
   expressionType: HL7Spec
expirationDate:
   type: DATE_TIME
   valueOf: RXA.16
   expressionType: HL7Spec
site:
   valueOf: datatype/CodeableConcept
   expressionType: resource
   specs: RXR.2
route:
   valueOf: datatype/CodeableConcept
   expressionType: resource
   specs: RXR.1
doseQuantity:
   condition: $value NOT_NULL
   valueOf: datatype/Quantity
   expressionType: resource
   specs: RXA.6 | RXA.7
   vars:
      value: DOSE_VALUE, RXA.6
      unit: RXA.7.1
      code: RXA.7.1
      sys: DOSE_SYSTEM, RXA.7.3
performer_1:
   valueOf: secondary/Performer
   generateList: true
   expressionType: resource
   vars:
      orderingProvider: ORC.12
performer_2:
   valueOf: secondary/Performer
   generateList: true
   expressionType: resource
   vars:
      administeringProvider: RXA.10
note:
   valueOf: datatype/Annotation
   expressionType: resource
   condition: $obx3 EQUALS 48767-8
   specs: OBX
   vars:
      obx3: STRING, OBX.3.1
      annotationText: STRING, OBX.5
reasonReference:
   valueOf: datatype/Reference
   expressionType: resource
   generateList: true
   specs: $Observation
   useGroup: true
isSubpotent:
   value: true
   condition: $rxa20 EQUALS PA
   vars:
      rxa20: String, RXA.20
programEligibility:
   valueOf: datatype/CodeableConcept
   expressionType: resource
   condition: $obx3 EQUALS 64994-7
   specs: OBX.5
   vars:
      obx3: String, OBX.3.1
fundingSource:
   valueOf: datatype/CodeableConcept
   expressionType: resource
   condition: $obx3 EQUALS 30963-3
   specs: OBX.5
   vars:
      obx3: String, OBX.3.1

reasonCode:
   valueOf: datatype/CodeableConcept
   expressionType: resource
   specs: RXA.19
recorded:
   type: DATE_TIME
   valueOf: RXA.22 | ORC.9
   expressionType: HL7Spec
reaction:
   condition: $obx31 EQUALS 31044-1
   valueOf: secondary/ImmunizationReaction
   generateList: true
   expressionType: resource
   specs: OBX
   vars:
      obx31: String, OBX.3.1


# See comments for Hl7ImmunizationFHIRConverstionTest.testMultipleNestedEducation
# which explains the input and expected output.

# The following loops over the OBX, but does not create the education element.
# Even if it did loop correctly, it doesn't group the related elements.
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
education:
   expressionType: nested
   evaluateLater: true
   generateList: true
   specs: OBX
   vars:
      refRecId: BUILD_IDENTIFIER, OBX.4 # Creates an identifier in $refRecId from OBX.4 for each time we cycle through the specs: DG1
   expressionsMap:
     education:
       valueOf: secondary/Education
       generateList: true
       expressionType: resource
       condition: $refconditionId EQUALS_STRING $refRecId # Inner loop (refconditionId) matches outer loop (refRecId)
       specs: OBX # Loops over the entire list of OBX records
       vars:
         # RefconditionId is calculated by getting the refRecId from the OBX
         refconditionId: String, OBX.4 
         presDate:  OBX.5
       constants:
         documentType: 'Vaccine Information Sheet'   
 
# The following creates the Education array, but does not group the results
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# It yeilds:
#   "education": [ {
#     "documentType": "DTaP, UF Information Sheet"
#   }, {
#     "documentType": "Hep B, UF Information Sheet"
#   }, {
#     "publicationDate": "2007-05-17"
#   }, {
#     "publicationDate": "2012-02-02"
#   }, {
#     "presentationDate": "2014-12-03"
#   }, {
#     "presentationDate": "2014-12-03"
#   } ]
# }
# education_1:
#    valueOf: secondary/Education
#    condition: $edCode EQUALS 30956-7
#    expressionType: resource
#    generateList: true
#    specs: OBX
#    vars:
#       documentType:  OBX.5.2 + $documentAppend
#       edCode: String, OBX.3.1
#    constants:
#       documentAppend: ' Information Sheet'          

# education_2:
#    valueOf: secondary/Education
#    condition: $edCode EQUALS 29768-9
#    expressionType: resource
#    generateList: true
#    specs: OBX
#    vars:
#       pubDate:  OBX.5
#       edCode: String, OBX.3.1

# education_3:
#    valueOf: secondary/Education
#    condition: $edCode EQUALS 29769-7
#    expressionType: resource
#    generateList: true
#    specs: OBX
#    vars:
#       presDate:  OBX.5
#       edCode: String, OBX.3.1  

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

